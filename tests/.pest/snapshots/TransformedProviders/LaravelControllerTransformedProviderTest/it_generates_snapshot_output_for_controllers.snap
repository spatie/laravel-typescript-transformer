export type RouteParams = Record<string, string | number>;

export type RouteDefinition = {
    url: string;
    method: string;
};

export type QueryParams = Record<string, string | number | boolean | null | undefined | (string | number | boolean)[]>;

export type RouteOptions = {
    query?: QueryParams;
};

export type MethodRoute = {
    method: string;
    url: string;
};

declare const baseUrl: string;

export function buildUrl(
    path: string,
    params?: RouteParams,
    options?: RouteOptions
): string {
    let url = path;

    if (params) {
        for (const [key, value] of Object.entries(params)) {
            url = url.replace(`{${key}}`, String(value));
        }
    }

    if (options?.query) {
        const searchParams = new URLSearchParams();

        for (const [key, value] of Object.entries(options.query)) {
            if (value === null || value === undefined) {
                continue;
            }

            if (Array.isArray(value)) {
                value.forEach((v) => searchParams.append(`${key}[]`, String(v)));
            } else {
                searchParams.append(key, String(value));
            }
        }

        const queryString = searchParams.toString();

        if (queryString) {
            url += '?' + queryString;
        }
    }

    return (typeof baseUrl !== 'undefined' ? baseUrl : '') + '/' + url;
}

type ActionResult = RouteDefinition & {
    url: string;
};

type ActionFunction<P extends RouteParams | undefined> = P extends undefined
    ? (options?: RouteOptions) => ActionResult
    : (params: P, options?: RouteOptions) => ActionResult;

type ActionWithMethods<P extends RouteParams | undefined, M extends string> = ActionFunction<P> & {
    [K in M]: ActionFunction<P>;
};

export function createActionWithMethods<P extends RouteParams | undefined = undefined, M extends string = string>(
    routes: MethodRoute[]
): ActionWithMethods<P, M> {
    const defaultRoute = routes[0];

    const createFn = (route: MethodRoute): ActionFunction<P> => {
        return ((...args: [P?, RouteOptions?]) => {
            const params = args[0] && typeof args[0] === 'object' && !('query' in args[0])
                ? args[0] as P
                : undefined;
            const options = params ? args[1] as RouteOptions : args[0] as RouteOptions;

            const url = buildUrl(route.url, params as RouteParams, options);

            return {
                url,
                method: route.method,
            };
        }) as ActionFunction<P>;
    };

    const fn = createFn(defaultRoute);

    const methodVariants: Record<string, ActionFunction<P>> = {};
    for (const route of routes) {
        methodVariants[route.method.toLowerCase()] = createFn(route);
    }

    return Object.assign(fn, methodVariants) as ActionWithMethods<P, M>;
}
/**
 * Spatie\LaravelTypeScriptTransformer\Tests\FakeClasses\InvokableController
 */
const InvokableController = createActionWithMethods<undefined>([
    { method: 'get', url: 'invokable' },
]);

namespace InvokableController {
    export type Request = object;
    export type Response = object;
}

export { InvokableController };

type ShowParams = {
    resource: string | number
};
type EditParams = {
    resource: string | number
};
type UpdateParams = {
    resource: string | number
};
type DestroyParams = {
    resource: string | number
};

/**
 * Spatie\LaravelTypeScriptTransformer\Tests\FakeClasses\ResourceController
 */
const ResourceController = {
    index: createActionWithMethods<undefined>([
        { method: 'get', url: 'resource' },
    ]),
    create: createActionWithMethods<undefined>([
        { method: 'get', url: 'resource/create' },
    ]),
    store: createActionWithMethods<undefined>([
        { method: 'post', url: 'resource' },
    ]),
    show: createActionWithMethods<ShowParams>([
        { method: 'get', url: 'resource/{resource}' },
    ]),
    edit: createActionWithMethods<EditParams>([
        { method: 'get', url: 'resource/{resource}/edit' },
    ]),
    update: createActionWithMethods<UpdateParams>([
        { method: 'put', url: 'resource/{resource}' },
    ]),
    destroy: createActionWithMethods<DestroyParams>([
        { method: 'delete', url: 'resource/{resource}' },
    ]),
} as const;

namespace ResourceController {
    export namespace index {
        export type Request = object;
        export type Response = object;
    }
    export namespace create {
        export type Request = object;
        export type Response = object;
    }
    export namespace store {
        export type Request = object;
        export type Response = object;
    }
    export namespace show {
        export type Request = object;
        export type Response = object;
    }
    export namespace edit {
        export type Request = object;
        export type Response = object;
    }
    export namespace update {
        export type Request = object;
        export type Response = object;
    }
    export namespace destroy {
        export type Request = object;
        export type Response = object;
    }
}

export { ResourceController };

